name: Sync Drupal Core Tags

on:
  schedule:
    - cron: "0 0 * * *" # run daily at midnight UTC
  workflow_dispatch: # allow manual trigger

jobs:
  sync-tags:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # needed for tag operations

      - name: Fetch drupal/core tags
        run: |
          git clone --quiet --bare https://github.com/drupal/core.git drupal-core.git
          cd drupal-core.git
          git tag > /tmp/drupal-tags.txt

      - name: Compare tags
        id: compare
        run: |
          MAX_MAJOR_VERSION=10

          # Filter tags to only those matching the desired major version
          grep -E "^${MAX_MAJOR_VERSION}\.[0-9]+\.[0-9]+$" /tmp/drupal-tags.txt | sort -V > /tmp/drupal-tags-major.txt
          git tag | grep -E "^${MAX_MAJOR_VERSION}\.[0-9]+\.[0-9]+$" | sort -V > /tmp/local-tags-major.txt

          LATEST_DRUPAL_TAG=$(tail -n 1 /tmp/drupal-tags-major.txt)
          LATEST_LOCAL_TAG=$(tail -n 1 /tmp/local-tags-major.txt)

          if [ "$LATEST_DRUPAL_TAG" != "" ] && [ "$LATEST_DRUPAL_TAG" != "$LATEST_LOCAL_TAG" ]; then
            echo "new_tag=$LATEST_DRUPAL_TAG" >> $GITHUB_OUTPUT
          fi

      - name: Create new tag in this repo
        if: steps.compare.outputs.new_tag != ''
        run: |
          TAG=${{ steps.compare.outputs.new_tag }}
          echo "Creating new tag: $TAG"
          git tag $TAG
          git push origin $TAG
